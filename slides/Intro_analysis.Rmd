---
title: 'An Introduction to R: Data Cleaning, Wrangling, Visualizing, and Everything Else'
subtitle: 'Part 3'
author: "Daniel Katz"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      titleSlideClass: ["center", "middle", "my-title"]
      highlightStyle: agate
      highlightLines: true


---

class: middle
```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```
```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
mono_light(base_color = "#151B54",
  code_highlight_color = "EDF803",
  link_color = "#4C4D41",
  code_inline_background_color = "#F2F9C9",
  code_inline_color = "#000000",
  code_font_google   = google_font("Droid Mono")
  )
```

```{r include=FALSE}
library(tidyverse)
co16 <- read_csv("C:/Users/katzd/Desktop/Github/perswebsite2/static/CDRPdata/cohort16.csv")

co16_rem <- select(co16, -X1)

state16 <- co16_rem %>% select(CDS:NumGraduates, NumDropouts,
                      gradrate = `Cohort Graduation Rate`,
                      droprate = `Cohort Dropout Rate`,
                      GEDrate = `GED Rate`)

state16d <- co16_rem %>% select(CDS:NumGraduates, NumDropouts,
                      gradrate = `Cohort Graduation Rate`,
                      droprate = `Cohort Dropout Rate`,
                      GEDrate = `GED Rate`) %>% 
  filter(AggLevel=="D", DFC=="N", Subgroup=="All", 
         Subgrouptype=="All")
```


## Tidy data principles
#### The notion of tidy data comes from Hadley Wickham, the author of the tidyverse
+ The philosophy of tidy data shapes the tidyverse

1. Each variable has its own column
2. Each observation has its own row
3. Each value has its own cell
--
Because...
1. Uniformity makes everything easier and you know how your data is stored
2. It makes vectorization easier

However, sometimes we need both tidy forms, and non-tidyforms of data 

---
Tidy (long data):
```{r echo=FALSE}
head(table1) %>% 
  knitr::kable(format = "html")
```

Not tidy (wide data):
```{r echo=FALSE}
head(table4a) %>% 
  knitr::kable(format = "html")
```
Years, here, are actually a value in their own right, thus values in a variable. Read more on the spread and gather functions, [here](https://r4ds.had.co.nz/tidy-data.html#spreading-and-gathering)

---
## Next functions go together, they're `group_by()` and `summarize()`

+ They do exactly what you think, but it's one of the more powerful tools in dplyr.

+ Let's use our `co16_rem` data.frame again

```{r}
names(co16_rem)
```
---
## The details
+ `group_by()` groups data together by some factor (such as class participation)

+ `summarize` performs some operation on the grouped data. 

+ This is often useful for carrying out summary statistics-type analysis

---
## Example `summarize()` and `group_by`

+ Let's get the average cohort size for males and females 

```{r}
table(co16_rem$Subgroup)
mvf <- co16_rem %>% 
  select(CDS, DFC, AggLevel, Subgroup, Subgrouptype,
         NumCohort) %>% 
  filter(AggLevel=="D", 
         DFC=="N",
         Subgroup=="FEM"| Subgroup=="MAL",  
         Subgrouptype=="All") %>% 
  group_by(Subgroup) %>% #<<
  summarize(mean_co = mean(NumCohort, na.rm = T), #<< 
            se = sd(NumCohort, na.rm = T)) #<<
```
```{r echo=FALSE}
head(mvf) %>% 
  knitr::kable(format = "html")

```
- The average number of females in a district is 471, standard error of 961.

---

class: middle

## Challenge, `group_by()` and `summarize()`

1. Edit the code above so you're grouping by Subgroup AND Subgrouptype (feel free to use help). 

2. However, with Subgroup, filter it first to include Male, Female, and "All".

3. We'll look at something the state of CA always looks at: group by Subgrouptype such that we keep only those classified by CA as "Hispanic or Latinx" (5), "African American" (6), "White, not Hispanic (7), and "All".

3. With as an outcome, instead of NumCohort, use NumGraduates

---
class: middle

# Solution

```{r}
mvf <- co16_rem %>% 
  select(CDS, DFC, AggLevel, Subgroup, Subgrouptype,
         NumGraduates) %>% 
  filter(AggLevel=="D", 
         DFC=="N",
         Subgroup=="MAL"| 
           Subgroup=="FEM"|
           Subgroup=="All"|
         Subgrouptype==5|
           Subgrouptype==6|
           Subgrouptype==7) %>% 
  group_by(Subgroup, Subgrouptype) %>%
  summarize(mean_grad = mean(NumGraduates, na.rm = T), 
            se = sd(NumGraduates, na.rm = T))

```
---
```{r echo=FALSE}
head(mvf) %>% 
  knitr::kable(format = "html")

```
---
```{r}
widemvf <- mvf %>% 
  gather(unit, numgrad, mean_grad:se) %>% 
  unite(temp1, Subgrouptype, unit, sep = ".") %>% 
  spread(temp1, numgrad)

widemvf
```
---
# What if I want to know frequencies?
 + Can just do the same as above but use `n()`
 
```{r}
freqtab <- co16 %>%
  group_by(Subgroup, Subgrouptype) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n))

```

```{r echo=FALSE}
head(freqtab) %>% 
  knitr::kable(format = "html")
```
---

class: middle

# Data VIZ with ggplot2
+ ggplot2 is a package built for visualizing all of our data. 

+ I might say we've done things a little backwards, it might be good to start with data visualization. 

+ the general form of ggplot is:
`ggplot(data, aes(mapping)) + geom_function(aes(mappings))`
---

class: middle 


### Building a ggplot


.pull-left[
1. Start with adding the data

1. Add an aesthetic internally or externally  

1. Add a geome (what kind of plot will it be?)   

1. Add other rules such as themes.  

1. Get help via documentation or other resources as you need]

--
.pull-right[
1. `ggplot(data)`

1. `ggplot(data =df, aes(x=x_var, y=y_var))` 

1. `ggplot(data=df, aes(x=x_var, y=y_var)) + geom_point(aes(color=grouo)) + geom_smooth(method=lm)`

1. `?ggplot2::geom_smooth`
]

`ggplot(data=state16d) +`
--
       `aes(x=droprate, y=GEDrate)) +`
--
         `geom_point(aes(color=Subgroup))`
  

---
## Example


```{r message=FALSE, warning=FALSE, fig.width = 5, fig.height = 5}

ggplot(data=state16d, 
       aes(x=droprate, y=GEDrate)) + 
         geom_point(aes(color=Subgroup)) +
         geom_smooth(method = lm) 

```

---
## Logic of ggplot2
+ "An aesthetic is a visual property of the objects in your plot. Aesthetics include things like the size, the shape, or the color of your points."
  - Garrett Grolemund & Hadley Wickham in [R for Data Science](https://r4ds.had.co.nz/data-visualisation.html#aesthetic-mappings)

+ That is, we have to make some decisions about how aesthetics should be mapped to your data. 

+ For instance, the x-axis aesthetic in the plot previously, was mapped to `Cohort Dropout Rate` and the color was mapped to `subgroup`

+ Other aesthetics include size and shape

+ It's important to know the `class` of your variables
---

# Another example
Just a histogram?

```{r message=FALSE, warning=FALSE, fig.width = 5, fig.height = 5}
ggplot(data=state16d, 
       aes(x=NumCohort)) + 
  geom_histogram()

  
```


---
## Warmup

```{r eval=F}

plot1 <- ggplot(data=state16d, 
                aes(x=droprate, y=GEDrate)) + 
         geom_point(aes(color=Subgroup))
```

1. What variables in state16d are categorical? Continuous? (hint, there's one command)

1. Using the code above, map a continuous variable to <mark>color</mark>, <mark>size</mark>, and <mark>shape</mark> (using geom_point). How do these aesthetics behave differently for categorical vs. continuous variables?

1. Use ?geom_point to find out what the `stroke` aesthetic does

1. instead of `color=Subgroup` above, use `color=GEDrate >.3`

1. What are three other `geom_functions`?

---
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=5}
plot1 <- ggplot(data=state16d, 
                aes(x=droprate, y=GEDrate)) + 
         geom_point(aes(color=GEDrate >.3))

```

---
# Challenge: Aesthetics
+ In California, Charter Schools are often continuation schools.

+ Much of the charter school debate doesn't really look at continuation schools

Using ggplot2, answer the questions:

+ Is there a relationship between the size of a school (NumCohort) and the grad rate (`Cohort Graduation Rate`)?

+ Does this relationship look different for charters and non-charter schools?

+ How might we visualize?

+ Hint, The code for school level data for AggLevel = "S", Use subgroup and subgrouptype ="All", start with co16_rem and filter

---
```{r fig.align="center", message=FALSE, warning=FALSE, fig.width = 5, fig.height = 5}
graphdata2 <- state16 %>% 
  filter(AggLevel=="S", 
         Subgroup=="All", 
         Subgrouptype=="All")

plot2 <- ggplot(graphdata2, 
            aes(NumCohort, `Cohort Graduation Rate`))+
  geom_point(aes(color=DFC)) 

```

---
## We can also do this with pipes all the way through
```{r message=FALSE, warning=FALSE, fig.width = 5, fig.height = 5}

plot2 <- state16 %>% 
  filter(AggLevel=="S", 
         Subgroup=="All", 
         Subgrouptype=="All") %>%
  ggplot(aes(x=NumCohort, y=gradrate))+
  geom_point(aes(color=DFC)) 

plot2
  

```

---

class: middle

## Using facets

+ Can we looked at the distributions of cohort sizes by non-charters and charters?

+ Can we answer the questions from the previous slides *within* charters and non-charters?

+ Absolutely, with facet_wrap

---

```{r message=FALSE, warning=FALSE, out.height = '40%'}
plot3 <- ggplot(graphdata2, 
            aes(NumCohort))+
  geom_histogram() + facet_wrap(~DFC)

plot3
```

---
# Challenge: Facets
+ Facets use `~` which denotes a `formula.`

+ A formula is simply another data-structure in R. Don't worry about that, for now. 

+ You can have two sides to the formula. To see this, run the code:
```{r message=FALSE, warning=FALSE}
graphdata3 <- state16 %>% 
  filter(AggLevel=="S", 
         Subgroup=="MAL"| Subgroup=="FEM", 
         Subgrouptype=="All")

plot4 <- ggplot(graphdata3, 
            aes(NumDropouts))+
  geom_histogram() + facet_wrap(~Subgroup, nrow=1)

#vs 

plot5 <- ggplot(graphdata3, 
            aes(NumDropouts))+
  geom_histogram() + facet_wrap(DFC~Subgroup)

```
---
# Plot 4
```{r message=FALSE, warning=FALSE, fig.width=5, fig.height=5, fig.align='center'}
plot4
```

---
# Plot 5
```{r message=FALSE, warning=FALSE, fig.width=5, fig.height=5, fig.align='center'}
plot5
```
---
class: middle
# What happens when you replace facet_wrap with facet_grid?

--
```{r message=FALSE, warning=FALSE, out.height = '40%'}
plot6 <- ggplot(graphdata3, 
            aes(NumDropouts))+
  geom_histogram() + facet_grid(DFC~Subgroup)

```
---
```{r message=FALSE, warning=FALSE}
plot6
```

---
class: middle 

## More on `geom_`
+ According to Hadley Wickham, author of ggplot2, `geom_` are so-called because they represent the geometric objects that we use to represent data

+ Boxplots use <mark>box geoms</mark>, line charts use <mark>line geoms</mark>, scatter plots use...
--
  + Point geoms
--
  
+ We can represent the same data in multiple ways using geoms_

+ we've already played with geoms above, to get a sense. 

+ Because of code completion, with `geom_ ` in a function, we can see our options.
---

## Geoms continued

+ we can add aesthetics just to that geom_function
```{r message=FALSE, warning=FALSE, fig.width = 5, fig.height = 5}
plot7 <- ggplot(graphdata3, 
            aes(x=NumDropouts, y = gradrate))+
  geom_point(aes(color=Subgroup))

plot7
```

---

class: middle

## Challenge (geoms)

1. Make a boxplot starting with `state16` data creating `graphdata4`
  + filter so `subgrouptype` = "All"
  + `Subgroup` = "MAL", "FEM" and "All"
  + looking at the difference between graduation rates (gradrates) for charters and non-charters, but just

2. Add a group to the boxplot such that you look at differences between charters and non-charters and the subgroups (using `Subgroup`) within each

--
1. Start with: 
```{r}
graphdata4 <- state16 %>% 
  filter(Subgroup=="MAL"| Subgroup=="FEM"|Subgroup=="All", 
         Subgrouptype=="All")
```

---
## Solutions

```{r, message=FALSE, warning=FALSE, fig.width = 6, fig.height = 6}
#bar chart
ggplot(graphdata4) + 
  geom_boxplot(aes(y = gradrate, x = DFC)) #<<
```

---

```{r fig.align="center", message=FALSE, warning=FALSE, fig.width = 5, fig.height = 5}
#bar chart
ggplot(graphdata4, aes(y = gradrate, x = DFC, fill = Subgroup)) +
                      geom_boxplot() #<<

```

---

class: middle 

## All the geoms
There are a lot of geoms_

See the most popular geoms, [_**here**_](https://eric.netlify.com/2017/08/10/most-popular-ggplot2-geoms/)


---
## Starting to think about descriptives, putting it together

+ Faceting is super useful when you want to look at correlations by group. Go back to `graphdata4`

```{r}

plotcorr <- ggplot(graphdata4, 
            aes(x=droprate, y = gradrate))+
  geom_point(aes(color=Subgroup)) + 
  facet_grid(Subgroup~DFC) 

```
---
```{r, fig.height=6}
plotcorr
```

---
## ggplot2 Labels

+  Adding labels is actually really simple

+ ggplot2 objects can be always added to with a `+`

+ What we'll add is `labs()`

```{r, fig.height=5, fig.width=5, fig.align="center"}

plotcorr <- plotcorr + 
  labs(y="Cohort Graduation Rate", 
       x= "Cohort Dropout Rate", 
       title = "Relationship between high school graduation rates and dropout rates",
       subtitle = "By California defined subgroup and charter school type")

plotcorr
```

---
## What about changing the legened?
This is a good resource for more on [_**ggplot text**_](http://r-statistics.co/Complete-Ggplot2-Tutorial-Part2-Customizing-Theme-With-R-Code.html): 
```{r, fig.height=5, fig.width=5, fig.align="center"}
plotcorr <- plotcorr +  
  scale_color_discrete(labels = c("All", "Female", "Male"))
plotcorr
```

---
## Labelling individual Cases (with GEDrates greater than 20%)
See package, [_**ggrepl**_](https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html) to make this cleaner
```{r, fig.height=5, fig.width=5, fig.align="center"}
plotlab <- plot1 +  geom_text(data=subset(graphdata4, GEDrate >30), 
          aes(x=droprate, y = GEDrate, label=Name))
          
plotlab
```
---
# There's much, much more:

+ Check out themes related to ggplot2

+ Check out how to make plots APA or the like, compliant here: [_**APA**_](https://ndphillips.github.io/IntroductionR_Course/assignments/wpa/wpa_5.html)

+ A good startin place, as usual, is the ggplot2 R studio [_**page**_](https://ggplot2.tidyverse.org/)  

---
# Exporting data/saving data

+ To export data from R is quite simple, but remember our directories! 

```{r echo=FALSE, out.width = '90%'}
knitr::include_graphics("directory.jpg")
```

+ We want to put any data we've cleaned in a folder called something like, "cleaneddata" and give it a name so we know what's in there. 

+ Remember `state16d`?

+ We'll use the `write_csv()` function from the `readr` package. 

+ general form (`write_csv(df, "folder/data.csv") - extension can be anything related to `write_*` start typing `write_` to see what happens...

+ What you save it as (in quotes) doesn't have to be the same as what it's called in R.

```{r, eval=F}
write_csv(state16d, "Cleandata/districtsub.csv")

# to write to SPSS
library(haven)
write_sav(state16d, "Cleandata/districtsub.sav")

# sav is an SPSS file extension

```
---

class: center

# Exporting ggplot2 object

```{r, eval=F}
ggsave("plots/plot1.pdf", plot1)

ggsave("plots/plot1.png", plot1)

# make it a certain size
ggsave("plots/plot1.png", width = 20, height = 20, units = "cm")
```


---
# Part 3.2: Descriptive statistics

---