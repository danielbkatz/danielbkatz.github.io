---
title: 'An Introduction to R: Data Cleaning, Wrangling, Visualizing, and Everything Else'
subtitle: 'Part 3'
author: "Daniel Katz"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: xaringan-themer.css
    nature:
      titleSlideClass: ["center", "middle", "my-title"]
      highlightStyle: agate
      highlightLines: true


---

class: middle
```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
```
```{r xaringan-themer, include = FALSE}
library(xaringanthemer)
mono_light(base_color = "#151B54",
  code_highlight_color = "#c0dbed",
  link_color = "#197b9e",
  #code_inline_background_color = "#F1948A",
  code_inline_color = "#1F618D",
  code_font_google   = google_font("Droid Mono")
  )
```

```{r include=FALSE}
library(tidyverse)
co16 <- read_csv("C:/Users/katzd/Desktop/Github/perswebsite2/static/CDRPdata/cohort16.csv")

co16_rem <- select(co16, -X1)

```
## Tidy data principles
#### The notion of tidy data comes from Hadley Wickham, the author of the tidyverse
+ The philosophy of tidy data shapes the tidyverse

1. Each variable has its own column
2. Each observation has its own row
3. Each value has its own cell

Because...
1. Uniformity makes everything easier and you know how your data is stored
2. It makes vectorization easier

However, sometimes we need both tidy forms, and non-tidyforms of data

---
Tidy (long data):
```{r echo=FALSE}
head(table1) %>% 
  knitr::kable(format = "html")
```

Not tidy (wide data):
```{r echo=FALSE}
head(table4a) %>% 
  knitr::kable(format = "html")
```
Years, here, are actually a value in their own right, thus values in a variable. Read more on the spread and gather functions, [here](https://r4ds.had.co.nz/tidy-data.html#spreading-and-gathering)

---
## Next functions go together, they're `group_by()` and `summarize()`

+ They do exactly what you think, but it's one of the more powerful tools in dplyr.

+ Let's use our `co16_rem` data.frame again

```{r}
names(co16_rem)
```
---
## The details
+ `group_by()` groups data together by some factor (such as class participation)

+ `summarize` performs some operation on the grouped data. 

+ This is often useful for carrying out summary statistics-type analysis

---
## Example `summarize()` and `group_by`

+ Let's get the average cohort size for males and females 

```{r}
table(co16_rem$Subgroup)
mvf <- co16_rem %>% 
  select(CDS, DFC, AggLevel, Subgroup, Subgrouptype,
         NumCohort) %>% 
  filter(AggLevel=="D", DFC=="N",
         Subgroup=="FEM"| Subgroup=="MAL",  
         Subgrouptype=="All") %>% 
  group_by(Subgroup) %>% #<<
  summarize(mean_co = mean(NumCohort, na.rm = T), #<< 
            se = sd(NumCohort, na.rm = T)) #<<
```
```{r echo=FALSE}
head(mvf) %>% 
  knitr::kable(format = "html")

```
- The average number of females in a district is 471, standard error of 961.

---

class: middle

## Challenge, `group_by()` and `summarize()`

1. Edit the code above so you're grouping by Subgroup and Subgrouptype. 

2. However, with Subgroup, filter it to include Male, Female, and "All".

3. We'll look at something the state of CA always looks at: group by Subgrouptype such that we keep only those classified by CA as "Hispanic or Latinx" (5), "African American" (6), "White, not Hispanic (7), and "All".

3. With as an outcome, instead of NumCohort, use NumGraduates

---
class: middle

# Solution

```{r}
mvf <- co16_rem %>% 
  select(CDS, DFC, AggLevel, Subgroup, Subgrouptype,
         NumGraduates) %>% 
  filter(AggLevel=="D", 
         DFC=="N",
         Subgroup=="MAL"| 
           Subgroup=="FEM"|
           Subgroup=="All"|
         Subgrouptype==5|
           Subgrouptype==6|
           Subgrouptype==7) %>% 
  group_by(Subgroup, Subgrouptype) %>%
  summarize(mean_grad = mean(NumGraduates, na.rm = T), 
            se = sd(NumGraduates, na.rm = T))

```
---
```{r echo=FALSE}
head(mvf) %>% 
  knitr::kable(format = "html")

```
---
```{r}
widemvf <- mvf %>% 
  gather(unit, numgrad, mean_grad:se) %>% 
  unite(temp1, Subgrouptype, unit, sep = ".") %>% 
  spread(temp1, numgrad)

widemvf
```
---
# What if I want to know frequencies?
 + Can just do the same as above but use `n()`
 
```{r}
freqtab <- co16 %>%
  group_by(Subgroup, Subgrouptype) %>%
  summarise (n = n()) %>%
  mutate(freq = n / sum(n))

```

```{r echo=FALSE}
head(freqtab) %>% 
  knitr::kable(format = "html")
```
---

class: middle

# Data VIZ with ggplot2
+ ggplot2 is a package built for visualizing all of our data. 

+ I might say we've done things a little backwards, it might be good to start with data visualization. 

+ the general form of ggplot is:
`ggplot(data, aes(mapping)) + geom_function(aes(mappings))`

---
## Example
.pull-left[
```{r}
graphdata <- co16_rem %>%
 filter(DFC == "N", 
        AggLevel=="D", 
        Subgroup != "All", 
        Subgrouptype=="All")

```

```{r plot-last, fig.show="hide", message=FALSE, warning=FALSE}

ggplot(data=graphdata, 
       aes(x=`Cohort Dropout Rate`, y=`GED Rate`)) + 
         geom_point(aes(color=Subgroup)) +
         geom_smooth(method = lm) 

  
```
]

.pull-right[
```{r ref.label = 'plot-last', echo = FALSE}
```
]
---
## Logic of ggplot2
+ "An aesthetic is a visual property of the objects in your plot. Aesthetics include things like the size, the shape, or the color of your points."
  - Garrett Grolemund & Hadley Wickham in [R for Data Science](https://r4ds.had.co.nz/data-visualisation.html#aesthetic-mappings)

+ That is, we have to make some decisions about how aesthetics should be mapped to your data. 

+ For instance, the x-axis aesthetic in the plot previously, was mapped to `Cohort Dropout Rate` and the color was mapped to `subgroup`

+ Other aesthetics include size and shape

+ It's important to know the `class` of your variables
---
# Another example
Just a histogram?

```{r}
ggplot(data=graphdata, 
       aes(x=NumCohort)) + 
  geom_histogram()
```


---
## Warmup

```{r eval=F}

graphdata <- co16_rem %>%
 filter(DFC == "N", 
        AggLevel=="D", 
        Subgroup != "All", 
        Subgrouptype=="All")

plot1 <- ggplot(data=graphdata, 
                aes(x=`Cohort Dropout Rate`, y=`GED Rate`)) + 
         geom_point(aes(color=Subgroup))
plot1

```

1. What variables in co16_rem are categorical? Continuous? (hint, there's one command)
1. Using `co16_rem` and the code above, map a continuous variable to color, size, and shape (using geom_point). How do these aesthetics behave differently for categorical vs. continuous variables?
1. Use ?geom_point to find out what the `stroke` aesthetic does
1. instead of `color=Subgroup` above, use `color=`GED Rate` >.3)
1. What other `geom_functions` are there?

---
# Challenge: Aesthetics
+ In California, Charter Schools are often continuation schools.

+ Much of the charter school debate doesn't really look at continuation schools

Using ggplot2, answer the questions:

+ Is there a relationship between the size of a school (NumCohort) and the grad rate (`Cohort Graduation Rate`)?

+ Does this relationship look different for charters and non-charter schools?

+ How might we visualize?

+ Hint, The code for school level data for AggLevel = "S", Use subgroup and subgrouptype ="All", start with co16_rem and filter

---
```{r out.height = '60%', fig.align="center"}
graphdata2 <- co16_rem %>% 
  filter(AggLevel=="S", 
         Subgroup=="All", 
         Subgrouptype=="All")

plot2 <- ggplot(graphdata2, 
            aes(NumCohort, `Cohort Graduation Rate`))+
  geom_point(aes(color=DFC)) 
plot2
  

```

---
## We can also do this with pipes all the way through
```{r}

plot2 <- co16_rem %>% 
  filter(AggLevel=="S", 
         Subgroup=="All", 
         Subgrouptype=="All") %>%
  ggplot(aes(x=NumCohort, y=`Cohort Graduation Rate`))+
  geom_point(aes(color=DFC)) 

plot2
  

```

---

class: middle

## Using facets

+ Can we looked at the distributions of cohort sizes by non-charters and charters?

+ Can we answer the questions from the previous slides *within* charters and non-charters?

+ Absolutely, with facet_wrap

---

```{r}
plot3 <- ggplot(graphdata2, 
            aes(NumCohort))+
  geom_histogram() + facet_wrap(~DFC)

plot3
```

---
# Challenge: Facets
+ Facets use `~` which denotes a `formula.`

+ A formula is simply another data-structure in R. Don't worry about that, for now. 

+ You can have two sides to the formula. To see this, run the code:
```{r}
graphdata3 <- co16_rem %>% 
  filter(AggLevel=="S", 
         Subgroup=="MAL"| Subgroup=="FEM", 
         Subgrouptype=="All")

plot4 <- ggplot(graphdata3, 
            aes(NumDropouts))+
  geom_histogram() + facet_wrap(~Subgroup, nrow=1)

#vs 

plot5 <- ggplot(graphdata3, 
            aes(NumDropouts))+
  geom_histogram() + facet_wrap(DFC~Subgroup)

```

---
```{r}
plot4
```
---
class: middle
# What happens when you replace facet_wrap with facet_grid?

---
```{r}
plot6 <- ggplot(graphdata3, 
            aes(NumDropouts))+
  geom_histogram() + facet_grid(DFC~Subgroup)

plot6
```

---

